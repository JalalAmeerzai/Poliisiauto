<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCM Test Client</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .container {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 8px;
        }

        h1 {
            color: #333;
        }

        .status {
            margin-bottom: 20px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
        }

        .token-box {
            word-break: break-all;
            background: #e8f0fe;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }

        .messages {
            margin-top: 20px;
        }

        .message {
            border-left: 4px solid #4CAF50;
            background: #f9f9f9;
            padding: 10px;
            margin-bottom: 10px;
        }

        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>FCM Notification Tester</h1>

        <div class="status" id="status">Status: Waiting for permission...</div>

        <button onclick="requestPermission()">Enable Notifications</button>

        <div id="token-container" class="token-box">
            <strong>Your Device Token:</strong><br>
            <span id="token-display"></span>
        </div>

        <div class="messages">
            <h3>Received Messages:</h3>
            <div id="messages-list"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDcOM_cKKAYcvM8jba33CryCQXpeeENdIQ",
            authDomain: "poliisiauto-fi.firebaseapp.com",
            projectId: "poliisiauto-fi",
            storageBucket: "poliisiauto-fi.firebasestorage.app",
            messagingSenderId: "707687366320",
            appId: "1:707687366320:web:d16b00b9580be0d80ac575"
        };

        const vapidKey = "BDq1yYZJIMeHjkywllxP-pIVwSqd7xtrMHUM5UMobIB6ZdejYluOcngM2QicSbzA4S7jUexkshC3e_5eAbQcXyA";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);

        // Handle incoming messages (foreground)
        onMessage(messaging, (payload) => {
            console.log('Message received. ', payload);
            addMessageToUI(payload);
        });

        function addMessageToUI(payload) {
            const list = document.getElementById('messages-list');
            const div = document.createElement('div');
            div.className = 'message';

            const title = payload.notification?.title || 'No Title';
            const body = payload.notification?.body || 'No Body';

            div.innerHTML = `<strong>${title}</strong><br>${body}<br><small>${new Date().toLocaleTimeString()}</small>`;
            list.prepend(div);
        }

        window.requestPermission = async () => {
            const statusDiv = document.getElementById('status');
            try {
                statusDiv.innerText = "Status: Requesting permission...";

                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    statusDiv.innerText = "Status: Permission granted. Registering Service Worker...";

                    // Explicitly register Service Worker
                    const registration = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
                    console.log('Service Worker registered:', registration);

                    statusDiv.innerText = "Status: Getting token...";
                    const token = await getToken(messaging, {
                        vapidKey: vapidKey,
                        serviceWorkerRegistration: registration
                    });
                    if (token) {
                        statusDiv.innerText = "Status: Connected!";
                        document.getElementById('token-container').style.display = 'block';
                        document.getElementById('token-display').innerText = token;
                        console.log("Device Token:", token);
                    } else {
                        statusDiv.innerText = "Status: No registration token available.";
                    }
                } else {
                    statusDiv.innerText = "Status: Permission denied.";
                }
            } catch (err) {
                console.error('An error occurred while retrieving token. ', err);
                statusDiv.innerText = "Status: Error - " + err.message;
            }
        }
    </script>
</body>

</html>